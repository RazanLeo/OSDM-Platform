# ๐๏ธ ERD - Entity Relationship Diagram

## ูุธุฑุฉ ุดุงููุฉ ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

ูุฐุง ุงููุณุชูุฏ ูุญุชูู ุนูู:
1. **Prisma Schema ุงููุงูู** - ุฌุงูุฒ ููุงุณุชุฎุฏุงู ุงููุจุงุดุฑ
2. **ูุฎุทุทุงุช ุงูุนูุงูุงุช** - ูููู ุงูุชุฑุงุจุท ุจูู ุงูุฌุฏุงูู
3. **ุงูุชุนูููุงุช ุงูุชูุตูููุฉ** - ููู ุฌุฏูู ูุญูู ููู

---

## ๐ ุฌุฏุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (28 ุฌุฏูู)

### ุงููุณุชุฎุฏููู ูุงููุตุงุฏูุฉ:
1. **User** - ุงูุญุณุงุจ ุงูููุญุฏ (ุจุงุฆุน + ูุดุชุฑู)
2. **Session** - ุฌูุณุงุช ุชุณุฌูู ุงูุฏุฎูู
3. **OAuthAccount** - ุญุณุงุจุงุช OAuth (Google, Apple, GitHub)

### ุงูุงุดุชุฑุงูุงุช ูุงูุฅูุฑุงุฏุงุช:
4. **Subscription** - ุงุดุชุฑุงูุงุช ุดูุฑูุฉ
5. **RevenueSettings** - ุฅุนุฏุงุฏุงุช ุงูุนูููุงุช ูุงูุฑุณูู

### ุงูุณูู ุงูุฃูู: ุงูููุชุฌุงุช ุงูุฌุงูุฒุฉ
6. **Product** - ููุชุฌุงุช ุฑูููุฉ ุฌุงูุฒุฉ
7. **ProductCategory** - ุชุตูููุงุช ุงูููุชุฌุงุช (300+)
8. **ProductFile** - ูููุงุช ุงูููุชุฌุงุช
9. **ProductReview** - ุชููููุงุช ุงูููุชุฌุงุช
10. **ProductOrder** - ุทูุจุงุช ุดุฑุงุก ุงูููุชุฌุงุช

### ุงูุณูู ุงูุซุงูู: ุงูุฎุฏูุงุช ุงููุฎุตุตุฉ
11. **Service** - ุงูุฎุฏูุงุช ุงููุฎุตุตุฉ (Gigs)
12. **ServiceCategory** - ุชุตูููุงุช ุงูุฎุฏูุงุช (100+)
13. **ServicePackage** - ุจุงูุงุช ุงูุฎุฏูุฉ (Basic, Standard, Premium)
14. **ServiceOrder** - ุทูุจุงุช ุงูุฎุฏูุงุช
15. **ServiceMilestone** - ูุนุงูู ุชุณููู ุงูุฎุฏูุงุช

### ุงูุณูู ุงูุซุงูุซ: ุงูุนูู ุงูุญุฑ
16. **Project** - ูุดุงุฑูุน ุงูุนูู ุงูุญุฑ
17. **ProjectCategory** - ุชุตูููุงุช ุงููุดุงุฑูุน
18. **Proposal** - ุนุฑูุถ ุงููุณุชูููู
19. **Contract** - ุนููุฏ ุงููุดุงุฑูุน
20. **Milestone** - ูุนุงูู ุงููุดุงุฑูุน

### ุงููุฏููุนุงุช ูุงูุถูุงู:
21. **Payment** - ุงููุฏููุนุงุช
22. **Escrow** - ุญุณุงุจ ุงูุถูุงู
23. **Wallet** - ูุญูุธุฉ ุงููุณุชุฎุฏู
24. **Withdrawal** - ุทูุจุงุช ุงูุณุญุจ

### ุงููุฒุงุนุงุช ูุงูุชูุงุตู:
25. **Dispute** - ุงููุฒุงุนุงุช
26. **Message** - ุงูุฑุณุงุฆู
27. **Notification** - ุงูุฅุดุนุงุฑุงุช

### ุงูุนุงู:
28. **AuditLog** - ุณุฌู ุงูุนูููุงุช (ููุฃูุงู)

---

## ๐ Prisma Schema ุงููุงูู

```prisma
// ============================================
// OSDM Platform - Complete Prisma Schema
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS - ุงูุชุนุฏุงุฏุงุช
// ============================================

enum UserRole {
  USER   // ูุณุชุฎุฏู ุนุงุฏู (ุจุงุฆุน + ูุดุชุฑู)
  ADMIN  // ูุฏูุฑ ุงูููุตุฉ
}

enum UserType {
  INDIVIDUAL  // ูุฑุฏ
  COMPANY     // ุดุฑูุฉ
}

enum SubscriptionTier {
  INDIVIDUAL  // 100 SAR/month
  SME         // 250 SAR/month
  LARGE       // 500 SAR/month
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING_PAYMENT
}

enum ProductStatus {
  DRAFT        // ูุณูุฏุฉ
  PENDING      // ูู ุงูุชุธุงุฑ ุงููุฑุงุฌุนุฉ
  APPROVED     // ูุนุชูุฏ ูููุดูุฑ
  REJECTED     // ูุฑููุถ
  SUSPENDED    // ููููู
}

enum ServiceStatus {
  ACTIVE       // ูุดุท
  PAUSED       // ูุชููู ูุคูุชุงู
  PENDING      // ูู ุงูุชุธุงุฑ ุงููุฑุงุฌุนุฉ
  REJECTED     // ูุฑููุถ
  SUSPENDED    // ููููู
}

enum ProjectStatus {
  OPEN         // ููุชูุญ ููุนุฑูุถ
  IN_PROGRESS  // ุฌุงุฑู ุงูุนูู
  COMPLETED    // ููุชูู
  CANCELLED    // ููุบู
  DISPUTED     // ุชุญุช ุงููุฒุงุน
}

enum OrderStatus {
  PENDING       // ูู ุงูุชุธุงุฑ ุงูุฏูุน
  PAID          // ูุฏููุน
  IN_PROGRESS   // ุฌุงุฑู ุงูุชูููุฐ
  DELIVERED     // ุชู ุงูุชุณููู
  COMPLETED     // ููุชูู
  CANCELLED     // ููุบู
  REFUNDED      // ูุณุชุฑุฏ
}

enum PaymentStatus {
  PENDING       // ูู ุงูุชุธุงุฑ ุงููุนุงูุฌุฉ
  COMPLETED     // ููุชูู
  FAILED        // ูุดู
  REFUNDED      // ูุณุชุฑุฏ
}

enum PaymentMethod {
  MADA
  VISA
  MASTERCARD
  APPLE_PAY
  STC_PAY
  PAYTABS
  MOYASAR
  PAYPAL
  GOOGLE_PAY
}

enum EscrowStatus {
  PENDING       // ูู ุงูุชุธุงุฑ ุงูุชุณููู
  HELD          // ูุญุชุฌุฒ
  RELEASED      // ูุญุฑุฑ ููุจุงุฆุน
  REFUNDED      // ูุณุชุฑุฏ ูููุดุชุฑู
  DISPUTED      // ุชุญุช ุงููุฒุงุน
}

enum DisputeStatus {
  OPEN          // ููุชูุญ
  UNDER_REVIEW  // ููุฏ ุงููุฑุงุฌุนุฉ
  RESOLVED      // ูุญููู
  ESCALATED     // ุชุตุนูุฏ ููุฅุฏุงุฑุฉ
  CLOSED        // ูุบูู
}

enum DisputeReason {
  NOT_DELIVERED          // ูู ูุชู ุงูุชุณููู
  INCOMPLETE_WORK        // ุนูู ุบูุฑ ููุชูู
  POOR_QUALITY           // ุฌูุฏุฉ ุฑุฏูุฆุฉ
  NOT_AS_DESCRIBED       // ุบูุฑ ูุทุงุจู ูููุตู
  BUYER_UNAVAILABLE      // ุงููุดุชุฑู ุบูุฑ ูุชุงุญ
  PAYMENT_ISSUE          // ูุดููุฉ ูู ุงูุฏูุน
  OTHER                  // ุฃุฎุฑู
}

enum WithdrawalStatus {
  PENDING       // ูู ุงูุชุธุงุฑ ุงููุนุงูุฌุฉ
  APPROVED      // ูุนุชูุฏ
  COMPLETED     // ููุชูู
  REJECTED      // ูุฑููุถ
}

enum NotificationType {
  ORDER           // ุทูุจ ุฌุฏูุฏ
  PAYMENT         // ุฏูุน
  MESSAGE         // ุฑุณุงูุฉ
  REVIEW          // ุชูููู
  DISPUTE         // ูุฒุงุน
  SYSTEM          // ุฅุดุนุงุฑ ุงููุธุงู
  MARKETING       // ุชุณููู
}

enum MarketType {
  PRODUCTS    // ุงูุณูู ุงูุฃูู: ุงูููุชุฌุงุช ุงูุฌุงูุฒุฉ
  SERVICES    // ุงูุณูู ุงูุซุงูู: ุงูุฎุฏูุงุช ุงููุฎุตุตุฉ
  PROJECTS    // ุงูุณูู ุงูุซุงูุซ: ุงูุนูู ุงูุญุฑ
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  username      String    @unique
  email         String    @unique
  password      String?   // nullable for OAuth users
  fullName      String
  phone         String?
  country       String
  role          UserRole  @default(USER)
  userType      UserType  @default(INDIVIDUAL)

  // Profile
  avatar        String?
  bio           String?   @db.Text
  skills        String[]  // ูููุณุชูููู
  languages     String[]  // ุงููุบุงุช ุงูุชู ูุชุญุฏุซูุง

  // Verification
  emailVerified Boolean   @default(false)
  phoneVerified Boolean   @default(false)

  // OAuth
  oauthAccounts OAuthAccount[]

  // Subscription
  subscription  Subscription?

  // Wallet
  wallet        Wallet?

  // ูุจุงุฆุน - ุงูุณูู ุงูุฃูู: ุงูููุชุฌุงุช ุงูุฌุงูุฒุฉ
  products      Product[]

  // ูุจุงุฆุน - ุงูุณูู ุงูุซุงูู: ุงูุฎุฏูุงุช ุงููุฎุตุตุฉ
  services      Service[]

  // ููุดุชุฑู - ุทูุจุงุช ุงูููุชุฌุงุช
  productOrdersAsBuyer  ProductOrder[] @relation("BuyerProductOrders")

  // ูุจุงุฆุน - ุทูุจุงุช ุงูููุชุฌุงุช
  productOrdersAsSeller ProductOrder[] @relation("SellerProductOrders")

  // ููุดุชุฑู - ุทูุจุงุช ุงูุฎุฏูุงุช
  serviceOrdersAsBuyer  ServiceOrder[] @relation("BuyerServiceOrders")

  // ูุจุงุฆุน - ุทูุจุงุช ุงูุฎุฏูุงุช
  serviceOrdersAsSeller ServiceOrder[] @relation("SellerServiceOrders")

  // ูุตุงุญุจ ุงููุดุฑูุน (Client)
  projectsAsClient      Project[]      @relation("ClientProjects")

  // ููุณุชูู (Freelancer)
  proposals             Proposal[]
  contractsAsFreelancer Contract[]     @relation("FreelancerContracts")

  // ูุตุงุญุจ ุงููุดุฑูุน
  contractsAsClient     Contract[]     @relation("ClientContracts")

  // Reviews
  reviewsGiven          ProductReview[] @relation("ReviewerReviews")
  reviewsReceived       ProductReview[] @relation("SellerReviews")

  // Messages
  messagesSent          Message[]       @relation("SenderMessages")
  messagesReceived      Message[]       @relation("RecipientMessages")

  // Disputes
  disputesAsComplainant Dispute[]       @relation("ComplainantDisputes")
  disputesAsRespondent  Dispute[]       @relation("RespondentDisputes")

  // Notifications
  notifications         Notification[]

  // Withdrawals
  withdrawals           Withdrawal[]

  // Sessions
  sessions              Session[]

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  @@index([email])
  @@index([username])
  @@index([role])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model OAuthAccount {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider     String   // google, apple, github
  providerId   String   // ID from provider
  accessToken  String?  @db.Text
  refreshToken String?  @db.Text
  expiresAt    DateTime?
  createdAt    DateTime @default(now())

  @@unique([provider, providerId])
  @@index([userId])
}

// ============================================
// SUBSCRIPTIONS & REVENUE
// ============================================

model Subscription {
  id              String              @id @default(cuid())
  userId          String              @unique
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier            SubscriptionTier
  status          SubscriptionStatus  @default(PENDING_PAYMENT)

  // Pricing
  monthlyPrice    Decimal             @db.Decimal(10, 2) // 100, 250, or 500 SAR

  // Billing
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean          @default(false)

  // Payment
  lastPaymentId   String?
  lastPaymentDate DateTime?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([userId])
  @@index([status])
}

model RevenueSettings {
  id                    String   @id @default(cuid())

  // Platform Commission (ูุณุจุฉ ุนูููุฉ ุงูููุตุฉ)
  platformCommission    Decimal  @default(25.00) @db.Decimal(5, 2) // 25%

  // Payment Gateway Fee (ุฑุณูู ุจูุงุจุฉ ุงูุฏูุน)
  paymentGatewayFee     Decimal  @default(5.00)  @db.Decimal(5, 2) // 5%

  // Monthly Subscription Prices
  individualPrice       Decimal  @default(100.00) @db.Decimal(10, 2) // 100 SAR
  smePrice              Decimal  @default(250.00) @db.Decimal(10, 2) // 250 SAR
  largePrice            Decimal  @default(500.00) @db.Decimal(10, 2) // 500 SAR

  // Dispute Window
  disputeWindowDays     Int      @default(7) // 7 days

  // Updated by admin only
  updatedAt             DateTime @updatedAt
  updatedBy             String?  // Admin user ID
}

// ============================================
// MARKET 1: READY-MADE PRODUCTS (ููุชุฌุงุช ุฌุงูุฒุฉ)
// ============================================

model ProductCategory {
  id          String    @id @default(cuid())
  nameAr      String
  nameEn      String
  slug        String    @unique
  icon        String?   // Icon name/path
  parentId    String?   // ููุชุตูููุงุช ุงููุฑุนูุฉ
  parent      ProductCategory? @relation("ProductCategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    ProductCategory[] @relation("ProductCategoryHierarchy")
  products    Product[]
  order       Int       @default(0) // ููุชุฑุชูุจ
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())

  @@index([slug])
  @@index([parentId])
}

model Product {
  id              String          @id @default(cuid())
  sellerId        String
  seller          User            @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  // Basic Info
  titleAr         String
  titleEn         String
  descriptionAr   String          @db.Text
  descriptionEn   String          @db.Text
  slug            String          @unique

  // Category
  categoryId      String
  category        ProductCategory @relation(fields: [categoryId], references: [id])

  // Pricing
  price           Decimal         @db.Decimal(10, 2)
  originalPrice   Decimal?        @db.Decimal(10, 2) // ููุชุฎููุถุงุช

  // Media
  thumbnail       String
  images          String[]        // ุตูุฑ ุฅุถุงููุฉ
  demoUrl         String?         // ุฑุงุจุท ุชุฌุฑูุจู/ูุนุงููุฉ

  // Files
  files           ProductFile[]

  // Metadata
  tags            String[]
  downloadCount   Int             @default(0)
  viewCount       Int             @default(0)

  // Status
  status          ProductStatus   @default(DRAFT)
  rejectionReason String?         @db.Text

  // Reviews
  reviews         ProductReview[]
  averageRating   Decimal         @default(0) @db.Decimal(3, 2)
  reviewCount     Int             @default(0)

  // Orders
  orders          ProductOrder[]

  // SEO
  metaTitleAr     String?
  metaTitleEn     String?
  metaDescAr      String?         @db.Text
  metaDescEn      String?         @db.Text

  // AI Generated
  aiGenerated     Boolean         @default(false)
  aiTags          String[]
  aiCategory      String?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  publishedAt     DateTime?

  @@index([sellerId])
  @@index([categoryId])
  @@index([status])
  @@index([slug])
}

model ProductFile {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  fileName    String
  fileUrl     String   // S3/MinIO URL
  fileSize    Int      // ุจุงูุจุงูุชุงุช
  fileType    String   // mime type

  createdAt   DateTime @default(now())

  @@index([productId])
}

model ProductReview {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  reviewerId  String
  reviewer    User     @relation("ReviewerReviews", fields: [reviewerId], references: [id], onDelete: Cascade)

  sellerId    String
  seller      User     @relation("SellerReviews", fields: [sellerId], references: [id], onDelete: Cascade)

  orderId     String   @unique // ูู ุทูุจ ูู ุชูููู ูุงุญุฏ

  rating      Int      // 1-5
  comment     String?  @db.Text

  // Seller Response
  sellerResponse String? @db.Text
  respondedAt    DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([productId])
  @@index([reviewerId])
  @@index([sellerId])
}

model ProductOrder {
  id              String        @id @default(cuid())
  orderNumber     String        @unique // PROD-XXXX-XXXX

  // Buyer
  buyerId         String
  buyer           User          @relation("BuyerProductOrders", fields: [buyerId], references: [id])

  // Seller
  sellerId        String
  seller          User          @relation("SellerProductOrders", fields: [sellerId], references: [id])

  // Product
  productId       String
  product         Product       @relation(fields: [productId], references: [id])

  // Pricing
  productPrice    Decimal       @db.Decimal(10, 2)
  platformFee     Decimal       @db.Decimal(10, 2) // 25%
  paymentFee      Decimal       @db.Decimal(10, 2) // 5%
  totalAmount     Decimal       @db.Decimal(10, 2)
  sellerEarning   Decimal       @db.Decimal(10, 2) // ุงููุจูุบ ุงูุตุงูู

  // Status
  status          OrderStatus   @default(PENDING)

  // Payment
  payment         Payment?

  // Escrow
  escrow          Escrow?

  // Delivery
  downloadUrl     String?       // ุฑุงุจุท ุชุญููู ูุคูุช
  downloadCount   Int           @default(0)
  downloadExpiresAt DateTime?   // ุตูุงุญูุฉ ุงูุชุญููู

  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  completedAt     DateTime?

  @@index([buyerId])
  @@index([sellerId])
  @@index([productId])
  @@index([status])
  @@index([orderNumber])
}

// ============================================
// MARKET 2: CUSTOM SERVICES (ุฎุฏูุงุช ูุฎุตุตุฉ)
// ============================================

model ServiceCategory {
  id          String    @id @default(cuid())
  nameAr      String
  nameEn      String
  slug        String    @unique
  icon        String?
  parentId    String?
  parent      ServiceCategory? @relation("ServiceCategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    ServiceCategory[] @relation("ServiceCategoryHierarchy")
  services    Service[]
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())

  @@index([slug])
  @@index([parentId])
}

model Service {
  id              String          @id @default(cuid())
  sellerId        String
  seller          User            @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  // Basic Info
  titleAr         String
  titleEn         String
  descriptionAr   String          @db.Text
  descriptionEn   String          @db.Text
  slug            String          @unique

  // Category
  categoryId      String
  category        ServiceCategory @relation(fields: [categoryId], references: [id])

  // Media
  thumbnail       String
  images          String[]
  videoUrl        String?

  // Packages (Basic, Standard, Premium)
  packages        ServicePackage[]

  // Metadata
  tags            String[]
  viewCount       Int             @default(0)
  orderCount      Int             @default(0)

  // Status
  status          ServiceStatus   @default(PENDING)
  rejectionReason String?         @db.Text

  // Rating
  averageRating   Decimal         @default(0) @db.Decimal(3, 2)
  reviewCount     Int             @default(0)

  // Orders
  orders          ServiceOrder[]

  // SEO
  metaTitleAr     String?
  metaTitleEn     String?
  metaDescAr      String?         @db.Text
  metaDescEn      String?         @db.Text

  // AI
  aiGenerated     Boolean         @default(false)
  aiTags          String[]
  aiCategory      String?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  publishedAt     DateTime?

  @@index([sellerId])
  @@index([categoryId])
  @@index([status])
  @@index([slug])
}

model ServicePackage {
  id              String        @id @default(cuid())
  serviceId       String
  service         Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  // Package Type
  type            String        // BASIC, STANDARD, PREMIUM

  // Details
  nameAr          String
  nameEn          String
  descriptionAr   String        @db.Text
  descriptionEn   String        @db.Text

  // Pricing
  price           Decimal       @db.Decimal(10, 2)

  // Delivery
  deliveryDays    Int           // ุนุฏุฏ ุฃูุงู ุงูุชุณููู
  revisions       Int           // ุนุฏุฏ ุงูุชุนุฏููุงุช

  // Features
  features        String[]      // ูุงุฆูุฉ ุงูููุฒุงุช

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([serviceId])
}

model ServiceOrder {
  id              String              @id @default(cuid())
  orderNumber     String              @unique // SERV-XXXX-XXXX

  // Buyer
  buyerId         String
  buyer           User                @relation("BuyerServiceOrders", fields: [buyerId], references: [id])

  // Seller
  sellerId        String
  seller          User                @relation("SellerServiceOrders", fields: [sellerId], references: [id])

  // Service
  serviceId       String
  service         Service             @relation(fields: [serviceId], references: [id])

  // Package Selected
  packageType     String              // BASIC, STANDARD, PREMIUM
  packagePrice    Decimal             @db.Decimal(10, 2)
  deliveryDays    Int
  revisions       Int

  // Buyer Requirements
  requirements    String              @db.Text
  attachments     String[]            // ูููุงุช ูุฑููุฉ ูู ุงููุดุชุฑู

  // Pricing
  platformFee     Decimal             @db.Decimal(10, 2) // 25%
  paymentFee      Decimal             @db.Decimal(10, 2) // 5%
  totalAmount     Decimal             @db.Decimal(10, 2)
  sellerEarning   Decimal             @db.Decimal(10, 2)

  // Status
  status          OrderStatus         @default(PENDING)

  // Payment
  payment         Payment?

  // Escrow
  escrow          Escrow?

  // Milestones
  milestones      ServiceMilestone[]

  // Delivery
  deliveredAt     DateTime?
  deliveryFiles   String[]
  deliveryNote    String?             @db.Text

  // Timestamps
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  completedAt     DateTime?
  deadline        DateTime?

  @@index([buyerId])
  @@index([sellerId])
  @@index([serviceId])
  @@index([status])
  @@index([orderNumber])
}

model ServiceMilestone {
  id              String        @id @default(cuid())
  orderId         String
  order           ServiceOrder  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  title           String
  description     String?       @db.Text
  amount          Decimal       @db.Decimal(10, 2)

  status          OrderStatus   @default(PENDING)

  deliveryFiles   String[]
  deliveryNote    String?       @db.Text

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deliveredAt     DateTime?
  acceptedAt      DateTime?

  @@index([orderId])
}

// ============================================
// MARKET 3: FREELANCE PROJECTS (ุนูู ุญุฑ)
// ============================================

model ProjectCategory {
  id          String    @id @default(cuid())
  nameAr      String
  nameEn      String
  slug        String    @unique
  icon        String?
  parentId    String?
  parent      ProjectCategory? @relation("ProjectCategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    ProjectCategory[] @relation("ProjectCategoryHierarchy")
  projects    Project[]
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())

  @@index([slug])
  @@index([parentId])
}

model Project {
  id              String          @id @default(cuid())
  clientId        String
  client          User            @relation("ClientProjects", fields: [clientId], references: [id], onDelete: Cascade)

  // Basic Info
  titleAr         String
  titleEn         String
  descriptionAr   String          @db.Text
  descriptionEn   String          @db.Text
  slug            String          @unique

  // Category
  categoryId      String
  category        ProjectCategory @relation(fields: [categoryId], references: [id])

  // Budget
  budgetMin       Decimal?        @db.Decimal(10, 2)
  budgetMax       Decimal?        @db.Decimal(10, 2)
  budgetType      String          // FIXED, HOURLY

  // Timeline
  duration        Int?            // ุนุฏุฏ ุงูุฃูุงู ุงููุชููุนุฉ
  deadline        DateTime?

  // Requirements
  skills          String[]
  attachments     String[]

  // Status
  status          ProjectStatus   @default(OPEN)

  // Proposals
  proposals       Proposal[]
  proposalCount   Int             @default(0)

  // Contract (ุนูุฏ ุงููุจูู)
  contract        Contract?

  // Metadata
  viewCount       Int             @default(0)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  publishedAt     DateTime?
  closedAt        DateTime?

  @@index([clientId])
  @@index([categoryId])
  @@index([status])
  @@index([slug])
}

model Proposal {
  id              String    @id @default(cuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  freelancerId    String
  freelancer      User      @relation(fields: [freelancerId], references: [id], onDelete: Cascade)

  // Proposal Details
  coverLetter     String    @db.Text
  proposedAmount  Decimal   @db.Decimal(10, 2)
  deliveryDays    Int

  // Attachments
  attachments     String[]

  // Milestones (optional)
  milestonesJson  String?   @db.Text // JSON array of milestones

  // Status
  status          String    @default("PENDING") // PENDING, ACCEPTED, REJECTED

  // Contract (ุฅุฐุง ุชู ุงููุจูู)
  contract        Contract?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([projectId])
  @@index([freelancerId])
}

model Contract {
  id              String      @id @default(cuid())
  contractNumber  String      @unique // PROJ-XXXX-XXXX

  // Project
  projectId       String      @unique
  project         Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Client (ุตุงุญุจ ุงููุดุฑูุน)
  clientId        String
  client          User        @relation("ClientContracts", fields: [clientId], references: [id])

  // Freelancer
  freelancerId    String
  freelancer      User        @relation("FreelancerContracts", fields: [freelancerId], references: [id])

  // Proposal
  proposalId      String      @unique
  proposal        Proposal    @relation(fields: [proposalId], references: [id])

  // Contract Terms
  totalAmount     Decimal     @db.Decimal(10, 2)
  platformFee     Decimal     @db.Decimal(10, 2) // 25%
  paymentFee      Decimal     @db.Decimal(10, 2) // 5%
  freelancerEarning Decimal   @db.Decimal(10, 2)

  startDate       DateTime    @default(now())
  deadline        DateTime?

  // Status
  status          ProjectStatus @default(IN_PROGRESS)

  // Payment
  payment         Payment?

  // Escrow
  escrow          Escrow?

  // Milestones
  milestones      Milestone[]

  // Completion
  deliveryFiles   String[]
  deliveryNote    String?     @db.Text
  completedAt     DateTime?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([projectId])
  @@index([clientId])
  @@index([freelancerId])
  @@index([proposalId])
  @@index([status])
}

model Milestone {
  id              String      @id @default(cuid())
  contractId      String
  contract        Contract    @relation(fields: [contractId], references: [id], onDelete: Cascade)

  title           String
  description     String?     @db.Text
  amount          Decimal     @db.Decimal(10, 2)
  deadline        DateTime?

  status          OrderStatus @default(PENDING)

  deliveryFiles   String[]
  deliveryNote    String?     @db.Text

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deliveredAt     DateTime?
  acceptedAt      DateTime?

  @@index([contractId])
}

// ============================================
// PAYMENTS & ESCROW
// ============================================

model Payment {
  id                String          @id @default(cuid())
  paymentNumber     String          @unique // PAY-XXXX-XXXX

  // Payer
  payerId           String

  // Amount
  amount            Decimal         @db.Decimal(10, 2)
  currency          String          @default("SAR")

  // Payment Method
  method            PaymentMethod

  // Status
  status            PaymentStatus   @default(PENDING)

  // Gateway Response
  gatewayTransactionId String?
  gatewayResponse      String?      @db.Text // JSON response

  // Market Type
  marketType        MarketType

  // Relations (one-to-one with orders)
  productOrder      ProductOrder?   @relation(fields: [productOrderId], references: [id])
  productOrderId    String?         @unique

  serviceOrder      ServiceOrder?   @relation(fields: [serviceOrderId], references: [id])
  serviceOrderId    String?         @unique

  contract          Contract?       @relation(fields: [contractId], references: [id])
  contractId        String?         @unique

  // Timestamps
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  completedAt       DateTime?

  @@index([payerId])
  @@index([status])
  @@index([paymentNumber])
}

model Escrow {
  id                String          @id @default(cuid())

  // Amount
  amount            Decimal         @db.Decimal(10, 2)

  // Buyer & Seller
  buyerId           String
  sellerId          String

  // Status
  status            EscrowStatus    @default(PENDING)

  // Market Type
  marketType        MarketType

  // Relations
  productOrder      ProductOrder?   @relation(fields: [productOrderId], references: [id])
  productOrderId    String?         @unique

  serviceOrder      ServiceOrder?   @relation(fields: [serviceOrderId], references: [id])
  serviceOrderId    String?         @unique

  contract          Contract?       @relation(fields: [contractId], references: [id])
  contractId        String?         @unique

  // Release/Refund
  releasedAt        DateTime?
  refundedAt        DateTime?

  // Timestamps
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
}

model Wallet {
  id              String        @id @default(cuid())
  userId          String        @unique
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Balance
  balance         Decimal       @default(0) @db.Decimal(10, 2)
  pendingBalance  Decimal       @default(0) @db.Decimal(10, 2) // ูู ุงูุถูุงู

  // Currency
  currency        String        @default("SAR")

  // Withdrawals
  withdrawals     Withdrawal[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([userId])
}

model Withdrawal {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  walletId        String
  wallet          Wallet            @relation(fields: [walletId], references: [id], onDelete: Cascade)

  // Amount
  amount          Decimal           @db.Decimal(10, 2)
  currency        String            @default("SAR")

  // Bank Details (JSON)
  bankDetails     String            @db.Text

  // Status
  status          WithdrawalStatus  @default(PENDING)

  // Admin Review
  reviewedBy      String?
  reviewNote      String?           @db.Text

  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  completedAt     DateTime?

  @@index([userId])
  @@index([walletId])
  @@index([status])
}

// ============================================
// DISPUTES & MESSAGING
// ============================================

model Dispute {
  id                String          @id @default(cuid())
  disputeNumber     String          @unique // DIS-XXXX-XXXX

  // Parties
  complainantId     String
  complainant       User            @relation("ComplainantDisputes", fields: [complainantId], references: [id])

  respondentId      String
  respondent        User            @relation("RespondentDisputes", fields: [respondentId], references: [id])

  // Order Type
  marketType        MarketType
  orderId           String          // ID of ProductOrder, ServiceOrder, or Contract

  // Dispute Details
  reason            DisputeReason
  description       String          @db.Text
  attachments       String[]

  // Status
  status            DisputeStatus   @default(OPEN)

  // Resolution
  resolution        String?         @db.Text
  resolvedBy        String?         // Admin user ID
  resolvedAt        DateTime?

  // Outcome
  refundAmount      Decimal?        @db.Decimal(10, 2)

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([complainantId])
  @@index([respondentId])
  @@index([status])
  @@index([disputeNumber])
}

model Message {
  id              String    @id @default(cuid())

  // Sender & Recipient
  senderId        String
  sender          User      @relation("SenderMessages", fields: [senderId], references: [id], onDelete: Cascade)

  recipientId     String
  recipient       User      @relation("RecipientMessages", fields: [recipientId], references: [id], onDelete: Cascade)

  // Content
  content         String    @db.Text
  attachments     String[]

  // Context (optional)
  orderId         String?   // ูุฑุจุท ุงููุญุงุฏุซุฉ ุจุทูุจ ูุนูู
  marketType      MarketType?

  // Status
  isRead          Boolean   @default(false)
  readAt          DateTime?

  createdAt       DateTime  @default(now())

  @@index([senderId])
  @@index([recipientId])
  @@index([orderId])
}

model Notification {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification Details
  type            NotificationType
  titleAr         String
  titleEn         String
  messageAr       String            @db.Text
  messageEn       String            @db.Text

  // Link
  link            String?

  // Status
  isRead          Boolean           @default(false)
  readAt          DateTime?

  createdAt       DateTime          @default(now())

  @@index([userId])
  @@index([isRead])
}

// ============================================
// AUDIT LOG (ููุฃูุงู ูุงููุฑุงูุจุฉ)
// ============================================

model AuditLog {
  id              String    @id @default(cuid())

  // User
  userId          String?
  userRole        String?

  // Action
  action          String    // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  entity          String    // User, Product, Order, etc.
  entityId        String?

  // Details
  changes         String?   @db.Text // JSON of changes
  ipAddress       String?
  userAgent       String?

  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
}
```

---

## ๐ ูุฎุทุทุงุช ุงูุนูุงูุงุช

### 1. ุงูุนูุงูุงุช ุงูุฑุฆูุณูุฉ ูููุณุชุฎุฏู (User)

```
User (ุงูุญุณุงุจ ุงูููุญุฏ)
โโโ OAuth Accounts (1:N)
โโโ Subscription (1:1)
โโโ Wallet (1:1)
โ
โโโ ูุจุงุฆุน ูู ุงูุณูู ุงูุฃูู:
โ   โโโ Products (1:N)
โ       โโโ ProductOrders as Seller (1:N)
โ
โโโ ูุจุงุฆุน ูู ุงูุณูู ุงูุซุงูู:
โ   โโโ Services (1:N)
โ       โโโ ServiceOrders as Seller (1:N)
โ
โโโ ูุตุงุญุจ ุงููุดุฑูุน ูู ุงูุณูู ุงูุซุงูุซ:
โ   โโโ Projects (1:N)
โ       โโโ Contracts as Client (1:N)
โ
โโโ ููุดุชุฑู ูู ุงูุณูู ุงูุฃูู:
โ   โโโ ProductOrders as Buyer (1:N)
โ
โโโ ููุดุชุฑู ูู ุงูุณูู ุงูุซุงูู:
โ   โโโ ServiceOrders as Buyer (1:N)
โ
โโโ ููุณุชูู ูู ุงูุณูู ุงูุซุงูุซ:
    โโโ Proposals (1:N)
        โโโ Contracts as Freelancer (1:N)
```

### 2. ุนูุงูุงุช ุงูุทูุจุงุช ูุงูุฏูุน

```
ProductOrder / ServiceOrder / Contract
โโโ Payment (1:1) - ุงูุฏูุน
โโโ Escrow (1:1) - ุงูุถูุงู
โโโ Dispute (1:N) - ุงููุฒุงุนุงุช
โโโ Messages (1:N) - ุงููุญุงุฏุซุงุช
```

### 3. ุนูุงูุงุช ุงูุชุตูููุงุช (Hierarchical)

```
ProductCategory / ServiceCategory / ProjectCategory
โโโ Parent Category (N:1)
โโโ Child Categories (1:N)
    โโโ Products/Services/Projects (1:N)
```

### 4. ุนูุงูุงุช ุงููุฑุงุฌุนุงุช ูุงูุชููููุงุช

```
Product
โโโ ProductReviews (1:N)
    โโโ Reviewer (User)
    โโโ Seller (User)
```

---

## ๐ ุงูููุงุชูุญ ูุงูููุงุฑุณ

### ููุงุชูุญ ุฃุณุงุณูุฉ (Primary Keys):
- ูู ุฌุฏูู: `id` (CUID)

### ููุงุชูุญ ูุฑูุฏุฉ (Unique Keys):
- `User`: `username`, `email`
- `Product/Service/Project`: `slug`
- `ProductOrder/ServiceOrder/Contract`: `orderNumber` / `contractNumber`
- `Payment`: `paymentNumber`
- `Dispute`: `disputeNumber`
- `Session`: `token`

### ููุงุฑุณ ููุฃุฏุงุก (Indexes):
- ุฌููุน `userId` - ููุงุณุชุนูุงูุงุช ุญุณุจ ุงููุณุชุฎุฏู
- ุฌููุน `status` - ููููุชุฑุฉ ุญุณุจ ุงูุญุงูุฉ
- ุฌููุน `categoryId` - ููููุชุฑุฉ ุญุณุจ ุงูุชุตููู
- ุฌููุน `slug` - ูุตูุญุงุช ุงูููุชุฌุงุช/ุงูุฎุฏูุงุช
- `createdAt` ูู AuditLog - ููุณุฌูุงุช ุงูุฒูููุฉ

---

## ๐ ููุงุญุธุงุช ูููุฉ

### 1. ุงูุญุณุงุจ ุงูููุญุฏ:
- **ุฌุฏูู ูุงุญุฏ** `User` ููู ุงููุณุชุฎุฏููู
- **ูุง ููุฌุฏ** ุฌุฏุงูู ูููุตูุฉ ูู Buyer/Seller
- ุงููุณุชุฎุฏู ูููู ุฃู ูููู ุจุงุฆุน ููุดุชุฑู ูู ููุณ ุงูููุช
- ุงูุนูุงูุงุช ููุตููุฉ ุจุงุณุชุฎุฏุงู `@relation` names

### 2. ูุธุงู ุงูุถูุงู (Escrow):
- ูู ุทูุจ ูู `Payment` ูุงุญุฏ
- ูู ุทูุจ ูู `Escrow` ูุงุญุฏ
- ุงูุญุงูุงุช: `PENDING` โ `HELD` โ `RELEASED` ุฃู `REFUNDED`

### 3. ุงูุนูููุงุช ูุงูุฑุณูู:
- ุนูููุฉ ุงูููุตุฉ: **25%** (ุซุงุจุชุฉ)
- ุฑุณูู ุงูุฏูุน: **5%** (ุซุงุจุชุฉ)
- ุงููุจุงูุบ ูุฎุฒูุฉ ูู `RevenueSettings` ููุชุนุฏูู ูู ุงูุฃุฏูู

### 4. ุงูุฃุณูุงู ุงูุซูุงุซุฉ:
- **ุงูุณูู ุงูุฃูู**: `Product` โ `ProductOrder`
- **ุงูุณูู ุงูุซุงูู**: `Service` โ `ServiceOrder`
- **ุงูุณูู ุงูุซุงูุซ**: `Project` โ `Proposal` โ `Contract`

### 5. ุงูุชุตูููุงุช:
- **300+ ุชุตููู** ููููุชุฌุงุช (`ProductCategory`)
- **100+ ุชุตููู** ููุฎุฏูุงุช (`ServiceCategory`)
- **ุชุตูููุงุช** ูููุดุงุฑูุน (`ProjectCategory`)
- ูุฌุจ ููุคูุง ุนุจุฑ **Seeder** ุจู Arabic + English

### 6. ุงููุฒุงุนุงุช:
- ูุชุฑุฉ ุงููุฒุงุน: **7 ุฃูุงู** (ูู `RevenueSettings`)
- ูููู ูููุดุชุฑู ุฃู ุงูุจุงุฆุน ูุชุญ ูุฒุงุน
- ุงูุฅุฏุงุฑุฉ ุชุญู ุงููุฒุงุนุงุช

### 7. ุงููุญูุธุฉ:
- ูู ูุณุชุฎุฏู ูู `Wallet` ูุงุญุฏ
- `balance` - ุงูุฑุตูุฏ ุงููุชุงุญ
- `pendingBalance` - ุงูุฑุตูุฏ ุงููุญุฌูุฒ ูู ุงูุถูุงู
- `Withdrawal` - ุทูุจุงุช ุงูุณุญุจ

---

## โ ุฌุงูุฒ ููุชูููุฐ

ูุฐุง ุงูู Schema ูุงูู ูุฌุงูุฒ ููุงุณุชุฎุฏุงู ูู:
1. `/prisma/schema.prisma`
2. ุชุดุบูู `npx prisma migrate dev`
3. ุฅูุดุงุก ุงูู Seeders ููุชุตูููุงุช

---

**๐ Created:** Phase 0 - ERD
**๐ Next:** API Contract (OpenAPI/Swagger)
